#!/bin/bash

# Determine the repository root based on this script's location
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Load environment variables if available
VENV_DIR="$SCRIPT_DIR/venv"
if [ -f "$VENV_DIR" ]; then
  . "$VENV_DIR"
fi

# Determine which Compose file to use. Prefer the multi-cluster
# configuration if present.
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yml"
if [ ! -f "$COMPOSE_FILE" ]; then
  COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yaml"
fi

# Choose the compose command based on what is installed
if command -v docker-compose >/dev/null 2>&1; then
  COMPOSE_CMD="docker-compose"
else
  COMPOSE_CMD="docker compose"
fi

cd "$SCRIPT_DIR" && \
  $COMPOSE_CMD -f "$COMPOSE_FILE" up -d && \
  echo "Waiting for Vault to become available..." && \
  until curl -s "$VAULT_ADDR/v1/sys/health" >/dev/null 2>&1; do
    sleep 2
  done && \
  vault operator unseal "$VAULT_SEAL_KEY"
